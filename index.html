<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>destiny-tracer ‚Äî Financial Calculator Suite</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css" />
  <style>
    /* Metal Prices Widget Styles */
    .metal-prices {
      margin: 24px 0;
      padding: 20px;
      background: var(--surface);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
    }

    .metal-prices-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }

    .metal-prices-title {
      display: flex;
      align-items: center;
      gap: 10px;
      margin: 0;
      font-size: 1.2rem;
      font-weight: 700;
      color: var(--accent-strong);
    }

    .metal-icon {
      font-size: 1.8rem;
    }

    .refresh-btn {
      padding: 6px 12px;
      border-radius: 6px;
      border: 1px solid var(--border);
      background: transparent;
      color: var(--muted);
      cursor: pointer;
      font-size: 0.85rem;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .refresh-btn:hover {
      background: var(--accent-1);
      color: white;
      border-color: var(--accent-1);
    }

    .refresh-btn.loading {
      opacity: 0.6;
      cursor: wait;
    }

    .metal-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
    }

    .metal-card {
      padding: 16px;
      border-radius: 10px;
      background: linear-gradient(135deg, var(--surface), var(--bg));
      border: 1px solid var(--border);
      transition: transform 0.2s;
    }

    .metal-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(15, 23, 42, 0.08);
    }

    .metal-card.gold {
      background: linear-gradient(135deg, #fff9e6, #fffbf0);
      border-color: #ffd700;
    }

    [data-theme="dark"] .metal-card.gold {
      background: linear-gradient(135deg, #3a3310, #2a2408);
      border-color: #ffd700;
    }

    .metal-card.silver {
      background: linear-gradient(135deg, #f5f5f5, #fafafa);
      border-color: #c0c0c0;
    }

    [data-theme="dark"] .metal-card.silver {
      background: linear-gradient(135deg, #2a2a2a, #1f1f1f);
      border-color: #c0c0c0;
    }

    .metal-name {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.9rem;
      color: var(--muted);
      margin-bottom: 8px;
      font-weight: 600;
    }

    .metal-name-icon {
      font-size: 1.3rem;
    }

    .metal-price {
      font-size: 1.8rem;
      font-weight: 700;
      color: var(--accent-strong);
      margin-bottom: 4px;
    }

    .metal-unit {
      font-size: 0.8rem;
      color: var(--muted);
      margin-bottom: 8px;
    }

    .metal-change {
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 0.85rem;
      font-weight: 600;
    }

    .metal-change.positive {
      color: #10b981;
    }

    .metal-change.negative {
      color: #ef4444;
    }

    .metal-loading {
      text-align: center;
      padding: 20px;
      color: var(--muted);
    }

    .metal-error {
      padding: 16px;
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid rgba(239, 68, 68, 0.3);
      border-radius: 8px;
      color: #dc2626;
      font-size: 0.9rem;
      text-align: center;
    }

    .metal-updated {
      text-align: center;
      font-size: 0.8rem;
      color: var(--muted);
      margin-top: 12px;
    }

    .spinner {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid var(--muted);
      border-top-color: transparent;
      border-radius: 50%;
      animation: spin 0.6s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    @media (max-width: 520px) {
      .metal-grid {
        grid-template-columns: 1fr;
      }

      .metal-price {
        font-size: 1.5rem;
      }
    }
  </style>
</head>

<body>
  <main class="site">
    <header class="header">
      <div class="brand">
        <svg class="logo" viewBox="0 0 24 24" aria-hidden="true">
          <defs>
            <linearGradient id="lg" x1="0" x2="1">
              <stop offset="0" stop-color="#0ea5a4" />
              <stop offset="1" stop-color="#3b82f6" />
            </linearGradient>
          </defs>
          <rect x="2" y="4" width="20" height="16" rx="4" fill="url(#lg)"></rect>
          <path d="M7 14l3-5 4 6 3-4" stroke="#fff" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"
            fill="none" />
        </svg>
        <div>
          <h1>destiny‚Äëtracer</h1>
          <p class="tagline">Smart Financial Calculators</p>
        </div>
      </div>
    </header>

    <div class="search-box">
      <input type="text" id="searchInput" placeholder="Search calculators..." />
      <span class="search-icon">üîç</span>
    </div>

    <section class="intro">
      <p>Your complete suite of financial calculators ‚Äî from investments to loans, all running privately in your
        browser. No data collection, no tracking, just helpful tools.</p>
    </section>

    <div class="stats-bar">
      <div class="stat-item">
        <span class="stat-value" id="totalCalcs">15</span>
        <span class="stat-label">Calculators</span>
      </div>
      <div class="stat-item">
        <span class="stat-value">5</span>
        <span class="stat-label">Categories</span>
      </div>
      <div class="stat-item">
        <span class="stat-value">100%</span>
        <span class="stat-label">Private</span>
      </div>
    </div>

    <!-- Metal Prices Widget -->
    <section class="metal-prices" id="metalPrices">
      <div class="metal-prices-header">
        <h2 class="metal-prices-title">
          <span class="metal-icon">üí∞</span>
          Today's Metal Prices
        </h2>
        <button class="refresh-btn" id="refreshPrices">
          <span id="refreshIcon">üîÑ</span>
          <span>Refresh</span>
        </button>
      </div>

      <div id="metalPricesContent">
        <div class="metal-loading">
          <div class="spinner"></div>
          <p>Loading prices...</p>
        </div>
      </div>

      <div class="metal-updated" id="lastUpdated"></div>
    </section>

    <!-- Investment Category -->
    <section class="category-section" data-category="investment">
      <div class="category-header">
        <div class="category-icon">üí∞</div>
        <div class="category-title">
          <h2>Investment Calculators</h2>
          <p>Plan your wealth creation journey</p>
        </div>
      </div>
      <div class="apps-grid">
        <a href="investments/sip/" class="app-card">
          <div class="app-header">
            <div class="app-icon">üìà</div>
            <h3 class="app-title">SIP Calculator</h3>
          </div>
          <p class="app-desc">Calculate returns from systematic investment plans with compound growth visualization.</p>
          <div class="app-meta">
            <span class="badge">Investment</span>
            <span class="link-arrow">Open</span>
          </div>
        </a>

        <a href="investments/swp/" class="app-card">
          <div class="app-header">
            <div class="app-icon">üí∏</div>
            <h3 class="app-title">SWP Calculator</h3>
          </div>
          <p class="app-desc">Plan systematic withdrawals and check corpus sustainability over time.</p>
          <div class="app-meta">
            <span class="badge">Investment</span>
            <span class="link-arrow">Open</span>
          </div>
        </a>

        <a href="investments/lumpsum/" class="app-card">
          <div class="app-header">
            <div class="app-icon">üíµ</div>
            <h3 class="app-title">Lumpsum Calculator</h3>
          </div>
          <p class="app-desc">Calculate returns on one-time investments with compound interest.</p>
          <div class="app-meta">
            <span class="badge">Investment</span>
            <span class="link-arrow">Open</span>
          </div>
        </a>

        <a href="investments/ppf/" class="app-card">
          <div class="app-header">
            <div class="app-icon">üèõÔ∏è</div>
            <h3 class="app-title">PPF Calculator</h3>
          </div>
          <p class="app-desc">Public Provident Fund calculator with 15-year maturity and tax benefits.</p>
          <div class="app-meta">
            <span class="badge">Investment</span>
            <span class="link-arrow">Open</span>
          </div>
        </a>

        <a href="investments/fd/" class="app-card">
          <div class="app-header">
            <div class="app-icon">üè¶</div>
            <h3 class="app-title">FD Calculator</h3>
          </div>
          <p class="app-desc">Fixed deposit maturity calculator with interest breakdown.</p>
          <div class="app-meta">
            <span class="badge">Investment</span>
            <span class="link-arrow">Open</span>
          </div>
        </a>
      </div>
    </section>

    <!-- Loan Category -->
    <section class="category-section" data-category="loans">
      <div class="category-header">
        <div class="category-icon">üè¶</div>
        <div class="category-title">
          <h2>Loan Calculators</h2>
          <p>EMI, amortization & loan planning</p>
        </div>
      </div>
      <div class="apps-grid">
        <a href="loans/home-loan/" class="app-card">
          <div class="app-header">
            <div class="app-icon">üè†</div>
            <h3 class="app-title">Home Loan EMI</h3>
          </div>
          <p class="app-desc">Calculate EMI with amortization schedule, charts and prepayment options.</p>
          <div class="app-meta">
            <span class="badge">Loan</span>
            <span class="link-arrow">Open</span>
          </div>
        </a>

        <a href="loans/personal-loan/" class="app-card">
          <div class="app-header">
            <div class="app-icon">üí≥</div>
            <h3 class="app-title">Personal Loan</h3>
          </div>
          <p class="app-desc">EMI calculator with detailed amortization schedule and total interest.</p>
          <div class="app-meta">
            <span class="badge">Loan</span>
            <span class="link-arrow">Open</span>
          </div>
        </a>

        <a href="loans/gold-loan/" class="app-card">
          <div class="app-header">
            <div class="app-icon">üíç</div>
            <h3 class="app-title">Gold Loan</h3>
          </div>
          <p class="app-desc">Loan against gold calculator with LTV ratio and interest breakdown.</p>
          <div class="app-meta">
            <span class="badge">Loan</span>
            <span class="link-arrow">Open</span>
          </div>
        </a>

        <a href="smartdebtaz/" class="app-card">
          <div class="app-header">
            <div class="app-icon">üìä</div>
            <h3 class="app-title">SmartDebt Analyzer</h3>
          </div>
          <p class="app-desc">Comprehensive debt and savings analyzer for financial planning.</p>
          <div class="app-meta">
            <span class="badge">Debt</span>
            <span class="link-arrow">Open</span>
          </div>
        </a>
      </div>
    </section>
    <!-- TRACKER Category -->
    <section class="category-section" data-category="Tracker">
      <div class="category-header">
        <div class="category-icon">üìã</div>
        <div class="category-title">
          <h2>Tracker</h2>
          <p>Tracker Calculators</p>
        </div>
      </div>
      <div class="apps-grid">
        <a href="tracker/splitexpense/" class="app-card">
          <div class="app-header">
            <div class="app-icon">‚Äçüë©üèª‚Äçüë¶üèª‚Äçüë¶üèª</div>
            <h3 class="app-title">Split Expense Calculators</h3>
          </div>
          <p class="app-desc">To split the expenses at one short and export</p>
          <div class="app-meta">
            <span class="badge">SplitExpense</span>
            <span class="link-arrow">Open</span>
          </div>
        </a>
        <a href="tracker/month-planner/" class="app-card">
          <div class="app-header">
            <div class="app-icon">‚Äçüìñ</div>
            <h3 class="app-title">Month Due Snapshot</h3>
          </div>
          <p class="app-desc">To record the monthly transaction and export for month book keeping</p>
          <div class="app-meta">
            <span class="badge">Month-Planner</span>
            <span class="link-arrow">Open</span>
          </div>
        </a>
        <a href="tracker/dailycashregister/" class="app-card">
          <div class="app-header">
            <div class="app-icon">‚Äçüìñ</div>
            <h3 class="app-title">Daily Cash Transactions</h3>
          </div>
          <p class="app-desc">To record the daily transaction and export for day book keeping</p>
          <div class="app-meta">
            <span class="badge">DailyCashRegister</span>
            <span class="link-arrow">Open</span>
          </div>
        </a>
        <a href="tracker/denominator/" class="app-card">
          <div class="app-header">
            <div class="app-icon">‚Äçüë©üèª‚Äçüë¶üèª‚Äçüë¶üèª</div>
            <h3 class="app-title">Denominator</h3>
          </div>
          <p class="app-desc">To calculate the currency denomination by giving whole amount or specify the currency</p>
          <div class="app-meta">
            <span class="badge">Denominator</span>
            <span class="link-arrow">Open</span>
          </div>
        </a>

      </div>
    </section>
    <!-- REALTY Category -->
    <section class="category-section" data-category="realty">
      <div class="category-header">
        <div class="category-icon">üè¶</div>
        <div class="category-title">
          <h2>Realty Calculators</h2>
          <p>Realty Calculators</p>
        </div>
      </div>
      <div class="apps-grid">
        <a href="realty/propertytax/" class="app-card">
          <div class="app-header">
            <div class="app-icon">üè†</div>
            <h3 class="app-title">Property Tax Calculators</h3>
          </div>
          <p class="app-desc">Calculate registration charges</p>
          <div class="app-meta">
            <span class="badge">Propertytax</span>
            <span class="link-arrow">Open</span>
          </div>
        </a>
        <a href="realty/gstcalc/" class="app-card">
          <div class="app-header">
            <div class="app-icon">üè†</div>
            <h3 class="app-title">GST Tax Calculators</h3>
          </div>
          <p class="app-desc">Advanced GST calculator with multiple tax slabs</p>
          <div class="app-meta">
            <span class="badge">GST</span>
            <span class="link-arrow">Open</span>
          </div>
        </a>
      </div>
    </section>


    <!-- Trading Category -->
    <section class="category-section" data-category="trading">
      <div class="category-header">
        <div class="category-icon">üìà</div>
        <div class="category-title">
          <h2>Trading & Brokerage</h2>
          <p>Stock calculations & broker charges</p>
        </div>
      </div>
      <div class="apps-grid">
        <a href="savgcalc/" class="app-card">
          <div class="app-header">
            <div class="app-icon">üíπ</div>
            <h3 class="app-title">SavgCalc</h3>
          </div>
          <p class="app-desc">Stock average calculator with fees, taxes and per-purchase breakdown.</p>
          <div class="app-meta">
            <span class="badge">Trading</span>
            <span class="link-arrow">Open</span>
          </div>
        </a>

        <a href="trading/zerodha/" class="app-card">
          <div class="app-header">
            <div class="app-icon">üìä</div>
            <h3 class="app-title">Zerodha Calculator</h3>
          </div>
          <p class="app-desc">Zero brokerage on delivery. Calculate charges for intraday, F&O trades.</p>
          <div class="app-meta">
            <span class="badge">Trading</span>
            <span class="link-arrow">Open</span>
          </div>
        </a>

        <a href="trading/kotak/" class="app-card">
          <div class="app-header">
            <div class="app-icon">üè¶</div>
            <h3 class="app-title">Kotak Securities</h3>
          </div>
          <p class="app-desc">Calculate brokerage for Classic, Neo, Prime plans with break-even price.</p>
          <div class="app-meta">
            <span class="badge">Trading</span>
            <span class="link-arrow">Open</span>
          </div>
        </a>

        <a href="bcc/" class="app-card">
          <div class="app-header">
            <div class="app-icon">üßæ</div>
            <h3 class="app-title">Brokerage Calculator</h3>
          </div>
          <p class="app-desc">Generic broker charges calculator for buy/sell transactions.</p>
          <div class="app-meta">
            <span class="badge">Trading</span>
            <span class="link-arrow">Open</span>
          </div>
        </a>
      </div>
    </section>

    <footer class="footer">
      <div class="footer-content">
        <div class="footer-links">
          <a href="https://github.com/destiny-tracer/destiny-tracer.github.io">GitHub</a>
          <a href="#privacy">Privacy</a>
          <a href="#about">About</a>
          <a href="#feedback">Feedback</a>
        </div>
        <small>Built by destiny-tracer ‚Äî All calculators run entirely in your browser. No data leaves your
          device.</small>
      </div>
    </footer>
  </main>

  <script src="common.js"></script>
  <script>
    (function () {
      const searchInput = document.getElementById('searchInput');
      const appCards = document.querySelectorAll('.app-card');
      const categories = document.querySelectorAll('.category-section');

      searchInput.addEventListener('input', function (e) {
        const query = e.target.value.toLowerCase().trim();

        if (query === '') {
          appCards.forEach(card => card.style.display = 'flex');
          categories.forEach(cat => cat.style.display = 'block');
          return;
        }

        let visibleCount = {};

        appCards.forEach(card => {
          const title = card.querySelector('.app-title').textContent.toLowerCase();
          const desc = card.querySelector('.app-desc').textContent.toLowerCase();
          const category = card.closest('.category-section').dataset.category;

          if (title.includes(query) || desc.includes(query)) {
            card.style.display = 'flex';
            visibleCount[category] = (visibleCount[category] || 0) + 1;
          } else {
            card.style.display = 'none';
          }
        });

        categories.forEach(cat => {
          const category = cat.dataset.category;
          cat.style.display = visibleCount[category] ? 'block' : 'none';
        });
      });

      // Count total calculators
      document.getElementById('totalCalcs').textContent = appCards.length;


      // ============================================
      // METALPRICEAPI WIDGET - FIXED FOR INR BASE
      // Metal Prices Widget - Daily Update at 6:00 AM IST
      // Fetches once per day, caches for 24 hours
      // ============================================

      (function () {
        // ============================================
        // CONFIGURATION
        // ============================================

        const API_KEY = 'jjkhkjh';
        const CACHE_KEY = 'metal-prices-cache';
        const UPDATE_HOUR = 6; // 6 AM IST
        const CACHE_DURATION = 86400000; // 24 hours

        // ============================================
        // MAIN FUNCTION
        // ============================================

        async function initMetalPrices() {
          console.log('üöÄ Initializing metal prices widget (Daily 6 AM update)');

          const content = document.getElementById('metalPricesContent');
          const refreshBtn = document.getElementById('refreshPrices');
          const refreshIcon = document.getElementById('refreshIcon');

          if (!content || !refreshBtn || !refreshIcon) {
            console.error('‚ùå Required elements not found');
            return;
          }

          // Check if we have valid cached data
          const cached = getCache();

          if (cached && !shouldFetchNew(cached.timestamp)) {
            console.log('‚úÖ Using cached prices from today');
            displayPrices(cached);
            updateTimestamp(cached.timestamp);
            scheduleNextUpdate(cached.timestamp);
            return;
          }

          // Need to fetch new data
          console.log('‚è∞ Time to fetch fresh prices...');

          try {
            refreshBtn.classList.add('loading');
            refreshIcon.innerHTML = '<span class="spinner"></span>';

            const data = await fetchFromMetalpriceAPI();

            if (!data) {
              console.log('‚ö†Ô∏è API failed, using fallback data');
              const fallbackData = getFallbackData();
              setCache(fallbackData);
              displayPrices(fallbackData);
              updateTimestamp(fallbackData.timestamp);
            } else {
              console.log('‚úÖ Fresh prices fetched successfully');
              setCache(data);
              displayPrices(data);
              updateTimestamp(data.timestamp);
            }

            scheduleNextUpdate(Date.now());

          } catch (error) {
            console.error('‚ùå Error fetching prices:', error);

            const oldCache = getCache(true);
            if (oldCache) {
              console.log('Using old cached data as fallback');
              displayPrices(oldCache);
              updateTimestamp(oldCache.timestamp);
            } else {
              displayError('Unable to fetch prices. Please try refreshing.');
            }
          } finally {
            refreshBtn.classList.remove('loading');
            refreshIcon.textContent = 'üîÑ';
          }
        }

        // ============================================
        // CHECK IF NEW FETCH IS NEEDED
        // ============================================

        function shouldFetchNew(lastFetchTime) {
          const now = new Date();
          const lastFetch = new Date(lastFetchTime);

          const todayUpdate = new Date();
          todayUpdate.setHours(UPDATE_HOUR, 0, 0, 0);

          if (now >= todayUpdate && lastFetch < todayUpdate) {
            console.log('üìÖ Past update time, need fresh data');
            return true;
          }

          const daysSinceLastFetch = Math.floor((now - lastFetch) / 86400000);
          if (daysSinceLastFetch >= 1) {
            console.log('üìÖ Last fetch was ' + daysSinceLastFetch + ' day(s) ago');
            return true;
          }

          console.log('‚úÖ Cache is fresh (updated today)');
          return false;
        }

        // ============================================
        // SCHEDULE NEXT AUTO-UPDATE
        // ============================================

        function scheduleNextUpdate(lastFetchTime) {
          const now = new Date();
          const nextUpdate = new Date();

          nextUpdate.setDate(now.getDate() + 1);
          nextUpdate.setHours(UPDATE_HOUR, 0, 0, 0);

          const todayUpdate = new Date();
          todayUpdate.setHours(UPDATE_HOUR, 0, 0, 0);

          if (now < todayUpdate) {
            nextUpdate.setDate(now.getDate());
          }

          const msUntilUpdate = nextUpdate - now;
          const hoursUntil = Math.floor(msUntilUpdate / 3600000);
          const minutesUntil = Math.floor((msUntilUpdate % 3600000) / 60000);

          console.log(`‚è∞ Next update in ${hoursUntil}h ${minutesUntil}m`);
          console.log(`üìÖ Next update: ${nextUpdate.toLocaleString('en-IN')}`);

          setTimeout(() => {
            console.log('üîî Scheduled update triggered');
            localStorage.removeItem(CACHE_KEY);
            initMetalPrices();
          }, msUntilUpdate);
        }

        // ============================================
        // FETCH FROM METALPRICEAPI - FIXED FOR INR
        // ============================================

        async function fetchFromMetalpriceAPI() {
          try {
            // FIXED: Proper API call with INR base
            // The trick is to NOT specify base parameter - it defaults to USD
            // Then we convert the response properly

            console.log('üåê Fetching from MetalpriceAPI...');

            // Option 1: Try without base parameter (works better with free tier)
            let url = `https://api.metalpriceapi.com/v1/latest?api_key=${API_KEY}&currencies=XAU,XAG`;

            let response = await fetch(url);
            console.log('üìä Response status:', response.status);

            if (!response.ok) {
              console.error('‚ùå API error:', response.status, response.statusText);

              // Option 2: Try with symbols parameter (alternative format)
              console.log('üîÑ Trying alternative format...');
              url = `https://api.metalpriceapi.com/v1/latest?api_key=${API_KEY}&symbols=XAU,XAG`;
              response = await fetch(url);

              if (!response.ok) {
                console.error('‚ùå Alternative format also failed');
                return null;
              }
            }

            const apiData = await response.json();
            console.log('üì¶ API Response:', apiData);

            if (!apiData.success) {
              console.error('‚ùå API returned error:', apiData.message);
              return null;
            }

            if (!apiData.rates || (!apiData.rates.XAU && !apiData.rates.XAUINR)) {
              console.error('‚ùå Invalid API response structure');
              return null;
            }

            // Convert to per 10 grams in INR
            const ozToGram = 31.1035;
            let goldPerOz, silverPerOz;

            // Check if we got direct INR rates (XAUINR) or USD rates (XAU)
            if (apiData.rates.XAUINR && apiData.rates.XAGINR) {
              // Direct INR rates
              console.log('‚úÖ Got direct INR rates');
              goldPerOz = 1 / apiData.rates.XAUINR;
              silverPerOz = 1 / apiData.rates.XAGINR;
            } else if (apiData.rates.XAU && apiData.rates.XAG) {
              // USD rates - need to convert to INR
              console.log('‚úÖ Got USD rates, converting to INR');
              const usdToInr = 83; // Current exchange rate
              const goldPerOzUSD = 1 / apiData.rates.XAU;
              const silverPerOzUSD = 1 / apiData.rates.XAG;
              goldPerOz = goldPerOzUSD * usdToInr;
              silverPerOz = silverPerOzUSD * usdToInr;
            } else {
              console.error('‚ùå Unexpected rate format');
              return null;
            }

            const goldPer10g = (goldPerOz / ozToGram * 10);
            const silverPer10g = (silverPerOz / ozToGram * 10);

            console.log('üí∞ Gold: ‚Çπ' + goldPer10g.toFixed(2) + ' per 10g');
            console.log('üí∞ Silver: ‚Çπ' + silverPer10g.toFixed(2) + ' per 10g');

            // Get previous day's data for change calculation
            const prevData = getCache(true);
            let goldChange = 0;
            let goldChangePct = 0;
            let silverChange = 0;
            let silverChangePct = 0;

            if (prevData && prevData.gold && prevData.silver) {
              const prevGold = parseFloat(prevData.gold.price);
              const prevSilver = parseFloat(prevData.silver.price);

              goldChange = goldPer10g - prevGold;
              goldChangePct = (goldChange / prevGold) * 100;

              silverChange = silverPer10g - prevSilver;
              silverChangePct = (silverChange / prevSilver) * 100;

              console.log(`üìà Gold: ${goldChangePct > 0 ? '+' : ''}${goldChangePct.toFixed(2)}%`);
              console.log(`üìà Silver: ${silverChangePct > 0 ? '+' : ''}${silverChangePct.toFixed(2)}%`);
            } else {
              console.log('‚ÑπÔ∏è No previous data for comparison');
            }

            return {
              gold: {
                price: goldPer10g.toFixed(2),
                change: goldChange.toFixed(2),
                changePercent: goldChangePct.toFixed(2)
              },
              silver: {
                price: silverPer10g.toFixed(2),
                change: silverChange.toFixed(2),
                changePercent: silverChangePct.toFixed(2)
              },
              timestamp: Date.now(),
              source: 'metalpriceapi',
              fetchTime: new Date().toLocaleString('en-IN')
            };

          } catch (error) {
            console.error('‚ùå API fetch failed:', error);
            return null;
          }
        }

        // ============================================
        // FALLBACK DATA
        // ============================================

        function getFallbackData() {
          console.log('‚ö†Ô∏è Using fallback data');

          return {
            gold: {
              price: "12500.00",
              change: "0.00",
              changePercent: "0.00"
            },
            silver: {
              price: "160.00",
              change: "0.00",
              changePercent: "0.00"
            },
            timestamp: Date.now(),
            source: 'fallback',
            fetchTime: new Date().toLocaleString('en-IN')
          };
        }

        // ============================================
        // DISPLAY FUNCTIONS
        // ============================================

        function displayPrices(data) {
          const content = document.getElementById('metalPricesContent');
          if (!content) return;

          const goldChange = parseFloat(data.gold.changePercent);
          const silverChange = parseFloat(data.silver.changePercent);

          const goldChangeAbs = Math.abs(parseFloat(data.gold.change));
          const silverChangeAbs = Math.abs(parseFloat(data.silver.change));

          content.innerHTML = `
      <div class="metal-grid">
        <div class="metal-card gold">
          <div class="metal-name">
            <span class="metal-name-icon">ü•á</span>
            <span>Gold (24K)</span>
          </div>
          <div class="metal-price">‚Çπ${formatNumber(data.gold.price)}</div>
          <div class="metal-unit">per 10 grams</div>
          <div class="metal-change ${goldChange >= 0 ? 'positive' : 'negative'}">
            <span>${goldChange > 0 ? '‚ñ≤' : goldChange < 0 ? '‚ñº' : '‚Äî'}</span>
            <span>${goldChange !== 0 ? Math.abs(goldChange).toFixed(2) + '%' : 'Unchanged'}</span>
            ${goldChange !== 0 ? `<span>(‚Çπ${goldChangeAbs.toFixed(2)})</span>` : ''}
          </div>
        </div>

        <div class="metal-card silver">
          <div class="metal-name">
            <span class="metal-name-icon">ü•à</span>
            <span>Silver</span>
          </div>
          <div class="metal-price">‚Çπ${formatNumber(data.silver.price)}</div>
          <div class="metal-unit">per 10 grams</div>
          <div class="metal-change ${silverChange >= 0 ? 'positive' : 'negative'}">
            <span>${silverChange > 0 ? '‚ñ≤' : silverChange < 0 ? '‚ñº' : '‚Äî'}</span>
            <span>${silverChange !== 0 ? Math.abs(silverChange).toFixed(2) + '%' : 'Unchanged'}</span>
            ${silverChange !== 0 ? `<span>(‚Çπ${silverChangeAbs.toFixed(2)})</span>` : ''}
          </div>
        </div>
      </div>
    `;
        }

        function displayError(message) {
          const content = document.getElementById('metalPricesContent');
          if (!content) return;

          content.innerHTML = `
      <div class="metal-error">
        ‚ö†Ô∏è ${message}
        <button onclick="location.reload()" style="margin-top:8px;padding:6px 12px;border-radius:6px;border:1px solid currentColor;background:transparent;color:inherit;cursor:pointer;">
          Retry
        </button>
      </div>
    `;
        }

        function formatNumber(num) {
          const number = parseFloat(num);
          if (isNaN(number)) return '‚Äî';

          return number.toLocaleString('en-IN', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
          });
        }

        function updateTimestamp(timestamp) {
          const updated = document.getElementById('lastUpdated');
          if (!updated) return;

          const date = new Date(timestamp);
          const time = date.toLocaleTimeString('en-IN', {
            hour: '2-digit',
            minute: '2-digit'
          });
          const dateStr = date.toLocaleDateString('en-IN', {
            day: 'numeric',
            month: 'short',
            year: 'numeric'
          });

          const now = new Date();
          const tomorrow = new Date();
          tomorrow.setDate(now.getDate() + 1);
          tomorrow.setHours(UPDATE_HOUR, 0, 0, 0);

          const todayUpdate = new Date();
          todayUpdate.setHours(UPDATE_HOUR, 0, 0, 0);

          const nextUpdate = now >= todayUpdate ? tomorrow : todayUpdate;
          const nextUpdateTime = nextUpdate.toLocaleTimeString('en-IN', {
            hour: '2-digit',
            minute: '2-digit'
          });

          updated.innerHTML = `
      Prices as of: ${time}, ${dateStr}<br>
      <span style="font-size:0.85em;color:var(--muted)">Next update: ${nextUpdateTime}</span>
    `;
        }

        // ============================================
        // CACHE MANAGEMENT
        // ============================================

        function getCache(ignoreExpiry = false) {
          try {
            const cached = localStorage.getItem(CACHE_KEY);
            if (!cached) {
              console.log('‚ÑπÔ∏è No cache found');
              return null;
            }

            const data = JSON.parse(cached);
            const now = Date.now();
            const age = now - data.timestamp;

            if (!ignoreExpiry && age > CACHE_DURATION) {
              console.log('‚ö†Ô∏è Cache expired (age: ' + Math.floor(age / 3600000) + ' hours)');
              return null;
            }

            const ageHours = Math.floor(age / 3600000);
            console.log(`‚úÖ Cache found (age: ${ageHours}h)`);
            return data;
          } catch (e) {
            console.error('‚ùå Cache read error:', e);
            return null;
          }
        }

        function setCache(data) {
          try {
            localStorage.setItem(CACHE_KEY, JSON.stringify(data));
            console.log('üíæ Prices cached (valid for 24 hours)');
          } catch (e) {
            console.error('‚ùå Failed to cache prices:', e);
          }
        }

        // ============================================
        // EVENT LISTENERS
        // ============================================

        const refreshButton = document.getElementById('refreshPrices');
        if (refreshButton) {
          refreshButton.addEventListener('click', () => {
            console.log('üîÑ Manual refresh triggered');
            const confirmed = confirm('This will fetch fresh prices and count as 1 API request. Continue?');
            if (confirmed) {
              localStorage.removeItem(CACHE_KEY);
              initMetalPrices();
            }
          });
        }

        // ============================================
        // INITIALIZE
        // ============================================

        console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
        console.log('üìä Metal Prices Widget - INR Fixed');
        console.log('‚è∞ Update schedule: Daily at ' + UPDATE_HOUR + ':00 AM IST');
        console.log('üìÖ API usage: ~30 requests/month');
        console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');

        initMetalPrices();

      })();
  </script>
</body>

</html>